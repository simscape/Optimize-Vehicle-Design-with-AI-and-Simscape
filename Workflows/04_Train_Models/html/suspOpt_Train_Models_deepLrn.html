<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      -->
<title>Train and Validate Deep Learning Surrogate Model of Design Space</title>
<meta name="generator" content="MATLAB 24.2">
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
<meta name="DC.date" content="2025-02-11">
<meta name="DC.source" content="suspOpt_Train_Models_deepLrn.m">
<style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style>
</head>
<body>
<div class="content">
<h1>Train and Validate Deep Learning Surrogate Model of Design Space</h1>
<!--introduction-->
<!--/introduction-->
<h2>Contents</h2>
<div>
<ul>
<li>
<a href="#1">Overview</a>
</li>
<li>
<a href="#2">Load Table of Design Parameters</a>
</li>
<li>
<a href="#3">Load and Analyze the Training Data</a>
</li>
<li>
<a href="#4">Verify Influence of Design Space Parameters on Performance Metrics</a>
</li>
<li>
<a href="#6">Split Data into Training and Test Data</a>
</li>
<li>
<a href="#7">Train the Networks Using the trainnet Function.</a>
</li>
<li>
<a href="#10">Save model and training data to use for optimization workflow</a>
</li>
</ul>
</div>
<h2 id="1">Overview</h2>
<p>This example trains an AI surrogate model from data generated by a vehicle dynamics model created in Simscape. Deep Learning is used for both the models and model training. The basic steps are:</p>
<div>
<ol>
<li>
<b>Prepare the data</b> collected from a DoE for training and testing</li>
<li>
<b>Select the models</b> that will be trained</li>
<li>
<b>Train the models</b> using a portion of the DoE data</li>
<li>
<b>Evaluate the accuracy</b> of all trained models</li>
<li>
<b>Select the model</b> for use in other steps of the design workflow</li>
</ol>
</div>
<p>
<img vspace="5" hspace="5" src="suspOpt_Workflow_Train_Models.png" alt=""> </p>
<p>The code used to create this documentation is here: <a href="matlab:edit('suspOpt_Train_Models_deepLrn.m');">suspOpt_Train_Models_deepLrn.m</a>
</p>
<p>(<a href="matlab:web('Vehicle_Design_Opt_with_AI_Overview.html')">return to Optimizing Vehicle Design Using AI and Simscape Overview</a>)</p>
<h2 id="2">Load Table of Design Parameters</h2>
<p>Adjusting the design requires selecting a set of design parameters to tune and setting ranges for those values. That set is defined in a table. For each parameter we specify:</p>
<div>
<ol>
<li>
<b>Label</b>: A short character string to identify the parameter</li>
<li>
<b>Parameter</b>: Location in a MATLAB structure where the parameter is defined</li>
<li>
<b>Index</b>: Index of the value within the structure field</li>
<li>
<b>Use</b>: Indicator if the parameter should be tuned (true/false). Set to "true" until a senstivity analysis has been performed.</li>
<li>
<b>Min</b>: Minimum value for parameter range</li>
<li>
<b>Max</b>: Maximum value for parameter range</li>
<li>
<b>Default</b>: Default value for parameter</li>
</ol>
</div>
<pre class="codeoutput">
ans =

  10&times;7 table

          Label                                     Parameter                                Index     Use      Min      Max     Default
    _________________    ________________________________________________________________    _____    _____    _____    _____    _______

    {'HP_A1_AR_Inbx'}    {'Vehicle.Chassis.SuspA1.AntiRollBar.sInboard.Value'           }      1      true     -0.35    -0.25      -0.3 
    {'HP_A1_Ro_Inbz'}    {'Vehicle.Chassis.SuspA1.Linkage.TrackRod.sInboard.Value'      }      3      true     0.175    0.235     0.205 
    {'HP_A1_Ro_Outz'}    {'Vehicle.Chassis.SuspA1.Linkage.TrackRod.sOutboard.Value'     }      3      true     0.155    0.235     0.185 
    {'HP_A2_AR_Inbx'}    {'Vehicle.Chassis.SuspA2.AntiRollBar.sInboard.Value'           }      1      true      0.25     0.35       0.3 
    {'HP_A2_AR_Outx'}    {'Vehicle.Chassis.SuspA2.AntiRollBar.sOutboard.Value'          }      1      true         0      0.1      0.05 
    {'HP_A2_AR_Outy'}    {'Vehicle.Chassis.SuspA2.AntiRollBar.sOutboard.Value'          }      2      true      0.55     0.65       0.6 
    {'HP_A2_LA_Outy'}    {'Vehicle.Chassis.SuspA2.Linkage.LowerWishbone.sOutboard.Value'}      2      true     0.656    0.756     0.706 
    {'HP_A2_LA_Outz'}    {'Vehicle.Chassis.SuspA2.Linkage.LowerWishbone.sOutboard.Value'}      3      true       0.1      0.2      0.15 
    {'HP_A2_LA_inRz'}    {'Vehicle.Chassis.SuspA2.Linkage.LowerWishbone.sInboardR.Value'}      3      true       0.1      0.2      0.15 
    {'HP_A2_UA_Outz'}    {'Vehicle.Chassis.SuspA2.Linkage.UpperWishbone.sOutboard.Value'}      3      true       0.4      0.5      0.45 

</pre>
<h2 id="3">Load and Analyze the Training Data</h2>
<p>Load results of DoE that generated training data. The scatter plots show the distribution of points. The constraint affecting the first two parameters is clearly seen in plots located in the upper left portion of the matrix of plots.</p>
<img vspace="5" hspace="5" src="suspOpt_Train_Models_deepLrn_01.png" alt=""> <h2 id="4">Verify Influence of Design Space Parameters on Performance Metrics</h2>
<p>The data from the DoE contains information of how the performance metrics (responses) are influenced by the design space parameters (predictors). The function <a href="matlab:doc('corr');">corr</a> shows the correlation. The plots below indicates that the braking metric is not heavily influenced by our design space parameters in the performed test.</p>
<img vspace="5" hspace="5" src="suspOpt_Train_Models_deepLrn_02.png" alt=""> <img vspace="5" hspace="5" src="suspOpt_Train_Models_deepLrn_03.png" alt=""> <p>Next, rank features for regression using minimum redundancy maximum relevance (MRMR) algorithm. The algorithm minimizes the redundancy of a feature set and maximizes the relevance of a feature set to the response variable. See <a href="matlab:doc('fsrmrmr')">fsrmrmr</a> documentation for more details. This plot also indicates that the braking metric is not heavily influenced by our design space parameters in the performed test.</p>
<img vspace="5" hspace="5" src="suspOpt_Train_Models_deepLrn_04.png" alt=""> <h2 id="6">Split Data into Training and Test Data</h2>
<p>To verify that our trained model predicts responses accurately, we will only use a portion of the data to train the model. The remainder of the data will be used to test the predictions of the performance metrics.</p>
<p>To ensure the training and test data fully represents the design space, we plot a histograms for each metric with the training data set and the testing data set. The distributions look similar to the distribution for the full set of data, indicating that we have good coverage of the design space.</p>
<pre class="codeoutput">Number of Test Points from DoE: 826
Test points for training: 661
Test points for testing:  165
</pre>
<img vspace="5" hspace="5" src="suspOpt_Train_Models_deepLrn_05.png" alt=""> <h2 id="7">Train the Networks Using the trainnet Function.</h2>
<p>Define a network with a feature input layer and specify the number of features. Also, configure the input layer to normalize the data using Z-score normalization. Train one network per performance metric.</p>
<p>We compare the performance metric predicted by the trained model against the true value from the original Simscape simulation. The most accurate models will be used for the following steps of the workflow.</p>
<img vspace="5" hspace="5" src="suspOpt_Train_Models_deepLrn_06.png" alt=""> <p>Roll Metric</p>
<img vspace="5" hspace="5" src="suspOpt_Train_Models_deepLrn_07.png" alt=""> <img vspace="5" hspace="5" src="suspOpt_Train_Models_deepLrn_08.png" alt=""> <p>Ride Metric</p>
<img vspace="5" hspace="5" src="suspOpt_Train_Models_deepLrn_09.png" alt=""> <img vspace="5" hspace="5" src="suspOpt_Train_Models_deepLrn_10.png" alt=""> <h2 id="10">Save model and training data to use for optimization workflow</h2>
<p class="footer">Copyright 2023-2024 The MathWorks, Inc.<br>
<a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2024b</a>
<br>
</p>
</div>
<!--
##### SOURCE BEGIN #####
%% Train and Validate Deep Learning Surrogate Model of Design Space
%

%% Overview
% This example trains an AI surrogate model from data generated by a
% vehicle dynamics model created in Simscape. Deep Learning is used for
% both the models and model training.  The basic steps are:
%
% # *Prepare the data* collected from a DoE for training and testing
% # *Select the models* that will be trained
% # *Train the models* using a portion of the DoE data
% # *Evaluate the accuracy* of all trained models
% # *Select the model* for use in other steps of the design workflow
%
% <<suspOpt_Workflow_Train_Models.png>>
%
% The code used to create this documentation is here: <matlab:edit('suspOpt_Train_Models_deepLrn.m'); suspOpt_Train_Models_deepLrn.m>
%
% (<matlab:web('Vehicle_Design_Opt_with_AI_Overview.html') return to Optimizing Vehicle Design Using AI and Simscape Overview>)
%
% Copyright 2023-2024 The MathWorks, Inc.

%% Load Table of Design Parameters
%
% Adjusting the design requires selecting a set of design parameters to
% tune and setting ranges for those values. That set is defined in a table.
% For each parameter we specify:
%
% # *Label*: A short character string to identify the parameter
% # *Parameter*: Location in a MATLAB structure where the parameter is
% defined
% # *Index*: Index of the value within the structure field
% # *Use*: Indicator if the parameter should be tuned (true/false). Set to
% "true" until a senstivity analysis has been performed.
% # *Min*: Minimum value for parameter range
% # *Max*: Maximum value for parameter range
% # *Default*: Default value for parameter

% Load parameter table with default values for all
% and with "Use" column set to true for the DoE parameters
load("parTableVal_trimSensitivity.mat");
parTableVal = parTableVal_trim;

useRows = parTableVal.Use == true;
sortrows(parTableVal(useRows,:))

%% Load and Analyze the Training Data
%
% Load results of DoE that generated training data. The scatter plots show
% the distribution of points.  The constraint affecting the first two
% parameters is clearly seen in plots located in the upper left portion of
% the matrix of plots.

% Load the full dataset
runTableFilename     = "doeRunTable.mat"; 
resultsTableFilename = "doeResultsTable.mat";

load(runTableFilename,"runTable");
load(resultsTableFilename,"resultsTable");

% Capture the variable names and descriptions (full parameter names)
inputVars = string(parTableVal.Label);
inputVars = inputVars(parTableVal.Use);
inputDescriptions = string(parTableVal.Parameter);
inputDescriptions = inputDescriptions(parTableVal.Use);
responseVars = string(resultsTable.Properties.VariableNames);
numInputs    = numel(inputVars);
numResponses = numel(responseVars);

% Create the data table
inputTable     = runTable(:,inputVars);
%predictorNames = string(inputTable.Properties.VariableNames);
% Append results to table
dataTable      = [inputTable resultsTable];

% Plot matrix of scatter plots
figure
[~,ax,bigax] = gplotmatrix(dataTable{:,:},[],[],[],[],[],[],[],...
    dataTable.Properties.VariableNames, dataTable.Properties.VariableNames);
title(['Scatter Plot of ' num2str(height(dataTable)) ' Samples for ' num2str(width(dataTable)-3) ' Parameters.'],'FontSize',18)

set(gcf,'Position',[54   255   850   706])
for j = 1:size(ax,1)
    for k = 1:size(ax,2)
        ax(j,k).XLabel.String = '';
        ax(j,k).YLabel.Interpreter = 'none';
        ax(j,k).YLabel.Rotation = 0;        
        ax(j,k).YTickLabel = [];        
    end
end

%% Verify Influence of Design Space Parameters on Performance Metrics
%
% The data from the DoE contains information of how the performance metrics
% (responses) are influenced by the design space parameters (predictors).
% The function <matlab:doc('corr'); corr> shows the correlation. The plots
% below indicates that the braking metric is not heavily influenced by
% our design space parameters in the performed test.

% Visualize the correlation between signals for predictors and responses
suspOpt_Train_Models_plotCorr(dataTable,inputVars,responseVars)

%%
% Next, rank features for regression using minimum redundancy maximum relevance (MRMR) algorithm.  
% The algorithm minimizes the redundancy of a feature set and maximizes the
% relevance of a feature set to the response variable. See
% <matlab:doc('fsrmrmr') fsrmrmr> documentation for more details. This
% plot also indicates that the braking metric is not heavily influenced by
% our design space parameters in the performed test.

% Rank features using MRMR algorithm for each response, sorted by
% ranking for first response.
suspOpt_Train_Models_plotMRMR(dataTable,responseVars);

% Remove braking metric as these tests do not show the parameters impact on
% that performance metric
ind_respVarKeep = ~startsWith(responseVars,'Brak');
responseVars = responseVars(ind_respVarKeep);
numInputs    = numel(inputVars);
numResponses = numel(responseVars);

% Create the data table
inputTable = runTable(:,inputVars);
dataTable = [inputTable resultsTable];

%% Split Data into Training and Test Data
%
% To verify that our trained model predicts responses accurately, we will
% only use a portion of the data to train the model.  The remainder of the
% data will be used to test the predictions of the performance metrics.
%
% To ensure the training and test data fully represents the design space,
% we plot a histograms for each metric with the training data set and the
% testing data set.  The distributions look similar to the distribution for
% the full set of data, indicating that we have good coverage of the design
% space.

% Split into training and test data
cv  = cvpartition(height(dataTable), HoldOut=0.2);
idx = training(cv);
trainingTable = dataTable(idx,:);
testTable     = dataTable(~idx,:);

disp(['Number of Test Points from DoE: ' num2str(height(dataTable))]);
disp(['Test points for training: ' num2str(height(trainingTable))]);
disp(['Test points for testing:  ' num2str(height(testTable))]);

% Show distribution of response values
figure;
ahH(1) = subplot(221);
histogram(ahH(1),trainingTable.(responseVars(1)),20)
title(ahH(1),[char(responseVars(1)) ' (Training)'])
ylabel(ahH(1),'Number of Tests');
ahH(2) = subplot(222);
histogram(ahH(2),trainingTable.(responseVars(2)),20)
title(ahH(2),[char(responseVars(2)) ' (Training)'])

ahH(3) = subplot(223);
histogram(ahH(3),testTable.(responseVars(1)),20)
title(ahH(3),[char(responseVars(1)) ' (Test)'])
ylabel(ahH(3),'Number of Tests');
xlabel('Value')
ahH(4) = subplot(224);
histogram(ahH(4),testTable.(responseVars(2)),20)
title(ahH(4),[char(responseVars(2)) ' (Test)'])
xlabel(ahH(4),'Value')

% Braking metric not shown - not enough influence
%ahH(3) = subplot(133);
%histogram(dataTable.(responseVars(3)))
%title(responseVars(3))

linkaxes(ahH(:),'y');
linkaxes(ahH([1 3]),'x');
linkaxes(ahH([2 4]),'x');

% Braking metric not plotted - not enough influence
%subplot(222);
%scatter(dataTable,responseVars(2),responseVars(3))
%box on
%subplot(223);
%scatter(dataTable,responseVars(2),responseVars(3))
%box on

%% Train the Networks Using the trainnet Function.
%
% Define a network with a feature input layer and specify the number of
% features. Also, configure the input layer to normalize the data using
% Z-score normalization. Train one network per performance metric.
%
% We compare the performance metric predicted by the trained model against
% the true value from the original Simscape simulation.  The most accurate
% models will be used for the following steps of the workflow.

[nnModel, tblTrainFtSelect] = suspOpt_Train_Models_deepLrn_trainnet(trainingTable,inputVars,responseVars(1:2)); %#ok<ASGLU>

%%
% Roll Metric

%close(gcf)
XTest = table2array(testTable(:,inputVars));
TTest = table2array(testTable(:,responseVars(1:2)));

[rollPr.acc.nn, rollPr.rSq.nn] = suspOpt_Train_Models_deepLrnTest(XTest,nnModel,TTest,responseVars,1);

%%
% Ride Metric
[ridePr.acc.nn, ridePr.rSq.nn] = suspOpt_Train_Models_deepLrnTest(XTest,nnModel,TTest,responseVars,2);


%% Save model and training data to use for optimization workflow
%save('deepLearningResults','tblTrainFtSelect','netRoll','netRide');

load("aiModels.mat","aiModels");
aiModels.nnModel = nnModel;
save('aiModels','aiModels','trainingTable','responseVars','rollPr','ridePr');


##### SOURCE END #####
-->
</body>
</html>
